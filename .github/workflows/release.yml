name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Get version
      id: version
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/v}
        fi
        echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
        echo "Building version: $VERSION"
    
    - name: Build application
      run: |
        make clean
        make build
        
    - name: Code sign application
      run: |
        codesign -s - --force --deep build/Notifier.app
        codesign -v build/Notifier.app
    
    - name: Create distribution package
      run: |
        VERSION="${{ steps.version.outputs.VERSION }}"
        ./release.sh $VERSION
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: notifier-${{ steps.version.outputs.VERSION }}
        path: dist/
    
    - name: Create Release
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          dist/notifier-${{ steps.version.outputs.VERSION }}-macos.tar.gz
          dist/checksums.txt
        body: |
          ## Notifier v${{ steps.version.outputs.VERSION }}
          
          ### Installation
          
          ```bash
          # Download and extract
          curl -L https://github.com/xorvo/notifier/releases/download/v${{ steps.version.outputs.VERSION }}/notifier-${{ steps.version.outputs.VERSION }}-macos.tar.gz -o notifier.tar.gz
          tar -xzf notifier.tar.gz
          
          # Install
          ./install.sh
          ```
          
          ### What's New
          - See [CHANGELOG.md](https://github.com/xorvo/notifier/blob/main/CHANGELOG.md) for details
          
          ### Checksums
          See `checksums.txt` in release assets
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}